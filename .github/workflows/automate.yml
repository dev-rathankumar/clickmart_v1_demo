name: Publish Clickmart Docker Image

on:
  push:
    branches:
      - main
 
jobs:
  push_to_registry:
    name: Build & Push Docker Images
    runs-on: ubuntu-latest
 
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
 
      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
 
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
 
      # Backend Image Build & Push
      - name: Build and Push Backend Docker Image
        uses: docker/build-push-action@v5
        with:
          context: ./backend-drf
          push: true
          tags: rathankumar492/clickmart-linode-backend-image:latest
          cache-from: type=registry,ref=rathankumar492/clickmart-linode-backend-image:latest
          cache-to: type=inline
         
 
      # Frontend Image Build & Push
      - name: Build and Push Frontend Docker Image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: rathankumar492/clickmart-linode-frontend-image:latest
          cache-from: type=registry,ref=rathankumar492/clickmart-linode-frontend-image:latest
          cache-to: type=inline
          build-args: |
            VITE_SERVER_BASE_URL=${{ secrets.VITE_SERVER_BASE_URL }}
 
         
  update_ssh_linode:
    name: Telling Linode Server to Update
    needs: "push_to_registry"
    runs-on: ubuntu-latest
 
    steps:
    - name: executing remote ssh commands using password
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: root
        key: ${{ secrets.LINODE_SSH_KEY }}
        port: 22
        script: |
            echo "Updating .env file on Linode for Backend..."
            cat <<EOF > /opt/linode-app/backend/.env
            SECRET_KEY=${{ secrets.SECRET_KEY }}
            DEBUG=${{ secrets.DEBUG }}
            DB_NAME=${{ secrets.DB_NAME }}
            DB_USER=${{ secrets.DB_USER }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            DB_HOST=${{ secrets.DB_HOST }}
            DB_PORT=${{ secrets.DB_PORT }}
            EMAIL_HOST_USER=${{ secrets.EMAIL_HOST_USER }}
            EMAIL_HOST_PASSWORD=${{ secrets.EMAIL_HOST_PASSWORD }}
           
            EOF
            echo "âœ… .env file updated!"
            echo "ðŸš€ Pulling new Docker image and restarting containers..."
            bash /opt/linode-app/update.sh  